#!/bin/bash
set -eu

### definitions
export PATH=$PWD/bin:$PATH
timestamp() { date +"%F %T.%N"; }
function runtox() {
    timestamp
    export TOXENV="$1"
    PYTEST_OPTIONS="
        --junit-xml=$CIRCLE_TEST_REPORTS/pytest/$CIRCLE_NODE_INDEX.$1.xml
        --junit-prefix=$1:
    " tox
}
function runlint() {
    timestamp
    rm -rf lint
    virtualenv lint --python="$1"
    inenv lint pip install -r requirements.d/lint.txt
    inenv lint make lint
}
trap timestamp EXIT

### main
set -x

### machine
timestamp
lsb_release -a
test $CIRCLE_NODE_TOTAL -eq 4

### dependencies
timestamp
sudo apt-get install python2.7-dev python3.4-dev
pip install --upgrade -r CI/requirements.txt

### test
case "$CIRCLE_NODE_INDEX" in
0)
    runlint python2.7
    runtox py27
    ;;
1)
    runtox py34
    ;;
2)
    runlint python3.4
    ./CI/circle/install-pypy pypy-4.0.1-linux64
    runtox pypy
    ;;
3)
    ./CI/circle/install-pypy pypy3-2.4.0-linux64
    runtox pypy3
    ;;
esac
